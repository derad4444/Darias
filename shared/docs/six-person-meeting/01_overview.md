# 6人会議機能 - 概要（既存DB活用 + キャッシュ最適化版）

## 📋 機能概要

「6人の自分に相談する」機能。ユーザーの性格（BIG5）を基に、6つの異なる視点から人生の悩みにアドバイスをもらえる。

### コアコンセプト
- ユーザーのBIG5性格診断データを活用
- 6人の異なる性格が「会議」形式で議論
- **既存の1,523ユーザー分の実データから統計を算出**
- **キャッシュ機能で会議内容を再利用（コスト80%削減）**
- チャット風UIで楽しく、説得力のあるアドバイス

---

## ✅ 確定した仕様

### 課金モデル
- **無料ユーザー**: 1回のみ（お試し）
- **プレミアム（980円/月）**: 無制限

### AIモデル
- **GPT-4o-mini** を使用
- コスト: 約0.1円/会議（キャッシュミス時、実測値0.0977円）
- コスト: 0円/会議（キャッシュヒット時）
- 品質: 脚本家アプローチで生々しい対話を実現
- 生成方式: **100% AI生成**（テンプレート不使用）

### データソース（重要な変更）
- **既存データを最大活用**
  - Big5Analysis: 89パターンの性格分析
  - PersonalityStatsMetadata: 1,523ユーザー分の統計
  - AI生成データは不要（実データで十分）

### キャッシュ戦略（新規追加）
- **shared_meetings コレクション**で会議内容を共有
- personalityKey + concernCategory でキャッシュ検索
- 同じ性格 × 同じカテゴリ = 同じ会話を再利用
- **キャッシュヒット率: 初期0% → 3ヶ月後80%**

### 会話生成
- **100% AI生成**: GPT-4o-miniで毎回生成
- **プロンプト方式**: 脚本家アプローチ
  - Phase制（3段階：本質探索 → 葛藤 → 統合）
  - 禁止表現リスト（教科書的表現を排除）
  - 推奨表現（問いかけ、感情、具体的経験）
  - BIG5パーソナライズ（各ユーザーのBIG5に基づく動的キャラクター生成）
- **キャッシュヒット時**: 再利用（0円、0.5秒）

---

## 🎯 ユーザーフロー

### パターン1: チャットからの提案（メイン導線）
```
1. ユーザーがチャットで悩みを話す
   「転職すべきか迷ってる...」

2. キャラクターが検知して提案
   「6人の自分に相談してみる？」

3. ボタンタップで6人会議画面へ

4. 【システム内部】
   a. personalityKey と concernCategory を取得
   b. shared_meetings から検索
   c. キャッシュヒット → 即座に表示（0円、0.5秒）
   d. キャッシュミス → 新規生成（0.12円、3-5秒）

5. チャット形式で会話を表示

6. 結論・統合レポート表示

7. ホームに戻ってキャラクターと会話
```

### パターン2: ホーム画面アイコンから
```
1. ホーム画面右上の💭アイコンタップ

2. 悩み入力画面
   - カテゴリ選択（キャリア、恋愛、etc）
   - 悩みを自由記述

3. 6人会議へ（キャッシュ検索 → 表示）
```

---

## 💰 コスト試算（キャッシュ効果含む）

### 1会議あたり（キャッシュミス時）
- Firestore検索: 約0.001円
- GPT-4o-mini（100% AI生成）: 約0.098円
  - 入力: 1,355 tokens × $0.150/1M = 0.0305円
  - 出力: 747 tokens × $0.600/1M = 0.0672円
  - 合計: 約0.0977円（実測値）
- Cloud Functions: 0.0003円
- **合計: 約0.1円/会議**（実測値: 0.0977円）

### 1会議あたり（キャッシュヒット時）
- Firestore検索: 0.0001円（1件のみ）
- usageCountインクリメント: 0.0003円
- **合計: 約0.0004円/会議 ≈ 0円**

### 月間コスト（プレミアム50人想定）

#### 初期（キャッシュヒット率0%）
```
50人 × 月5回 = 250会議/月
250会議 × 0.1円 = 25円/月
```

#### 1ヶ月後（キャッシュヒット率50%）
```
・ヒット: 125会議 × 0円 = 0円
・ミス: 125会議 × 0.1円 = 12.5円
合計: 12.5円/月（50%削減）
```

#### 3ヶ月後（キャッシュヒット率80%）
```
・ヒット: 200会議 × 0円 = 0円
・ミス: 50会議 × 0.1円 = 5円
合計: 5円/月（80%削減）
```

### 年間収支（3ヶ月後の安定期）
- 収益: 50人 × 980円 × 12ヶ月 = **588,000円/年**
- コスト: 5円 × 12ヶ月 = **60円/年**
- **利益率: 99.99%**

### キャッシュの効果

```
レスポンス時間
・ミス: 30-40秒（AI生成 + アニメーション）
・ヒット: 30-40秒（キャッシュ読み込みは0.5秒だがアニメーションは同じ）

コスト削減
・初期: 25円/月
・3ヶ月後: 5円/月（80%削減）

追加メリット
・Firestore読み取り: 80%削減
・API呼び出し: 80%削減
・サーバー負荷: 大幅軽減
・品質向上: 100% AI生成で生々しい対話
```

---

## 🎨 UI/UXの特徴

### 1. キャラクター可視化
- 各キャラクターの性格を説明文で表示
- BIG5数値は非表示（ユーザーフレンドリー）
- アイコンで視覚的に区別

### 2. 会話形式
- LINEのようなチャットUI
- **2.5〜5秒ごとにメッセージ表示**（メッセージ長に応じて動的調整）
  - ベース: 2.5秒
  - 追加: 1文字あたり0.017秒
  - 上限: 5秒
- 左右交互配置（慎重派 vs 行動派）

### 3. アニメーション
- メッセージのスライドイン（フェードイン）
- メッセージ長に応じた適切な読書時間
- スムーズな画面遷移
- **キャッシュヒット時も同じアニメーション（違和感なし）**
- スキップ機能（結論へジャンプ）

### 4. インタラクション
- スキップ機能（結論へジャンプ）
- 投票機能（どの意見が良かった？）
  - shared_meetings の評価に反映
  - 高評価の会議が優先的に表示される
- 質問機能（会話中に質問できる - Phase 2）

---

## 📊 データフロー（キャッシュ優先）

```
ユーザーが悩みを入力
↓
personalityKey 取得（例: "O4_C4_E2_A4_N3_female"）
↓
concernCategory 検出（例: "career"）
↓
【最重要】shared_meetings から検索
WHERE personalityKey == user.personalityKey
AND concernCategory == user.concernCategory
↓
キャッシュヒット？
├─ YES → shared_meetings から取得（0円、0.5秒）
│         usageCount をインクリメント
│         meeting_history に参照を保存
│         表示
│
└─ NO  → 新規生成開始
          ├─ Big5Analysis から類似性格検索
          ├─ PersonalityStatsMetadata から人数取得
          ├─ 統計データ算出
          ├─ テンプレート選択 or GPT-4o-mini生成
          ├─ shared_meetings に保存（キャッシュ化）
          ├─ meeting_history に参照を保存
          └─ 表示（0.12円、3-5秒）
```

---

## 📅 実装フェーズ

### Phase 1: MVP（完了）✅
- **データ準備（0円）**
  - 既存のBig5Analysis活用
  - PersonalityStatsMetadata活用
  - AI生成データベースは不要

- **バックエンド実装**✅
  - shared_meetings コレクション設計
  - キャッシュ検索ロジック実装
  - Cloud Functions実装
  - **100% AI生成プロンプト**
    - 脚本家アプローチ
    - Phase制（3段階）
    - 禁止表現リスト
    - BIG5パーソナライズ

- **フロントエンド実装**✅
  - チャット風UI実装
  - meeting_history 表示機能
  - 投票機能
  - メッセージ長対応アニメーション（2.5〜5秒）

- **初期投資: 0円（既存データ活用）**

### Phase 2: 機能拡張（2ヶ月目）
- プロンプトの継続改善
  - ユーザーフィードバックに基づく調整
  - 禁止表現リストの拡充
- キャッシュヒット率分析
- 人気会議ランキング機能
- 高評価会議のレコメンド
- 運用コスト: 約12.5円/月（キャッシュ50%）

### Phase 3: 完全版（3ヶ月目以降）
- 質問機能（会話中にユーザーが質問）
- 詳細な個別ストーリー閲覧
- キャッシュ最適化（80%ヒット率達成）
- 低評価会議の自動再生成
- 運用コスト: 約5円/月（キャッシュ80%）

---

## 🔍 キャッシュデータの管理

### キャッシュの仕組み
```
89パターンの性格 × 10カテゴリ = 最大890キャッシュ

実際には人気パターンに集中するため:
・主要100パターンで70%カバー
・主要500パターンで95%カバー
```

### キャッシュの品質管理
```
✅ usageCount で人気度を追跡
✅ ratings で品質を追跡（評価平均4.0以下は改善）
✅ 低評価のキャッシュは自動的にAI再生成
✅ 定期的にテンプレートをアップデート
```

### キャッシュのプライバシー
```
✅ 個人を特定できる情報は含まない
✅ personalityKey はハッシュ化された識別子
✅ 会話内容に固有名詞は含まれない
✅ 全ユーザーが同じキャッシュを安全に利用可能
```

---

## 🔒 プライバシー・倫理

### データの匿名化
- 完全匿名ID（ユーザー特定不可）
- personalityKey: "O4_C4_E2_A4_N3_female" のみ
- 具体的な会社名・地域は保存しない
- 年齢は範囲で保存（25-29歳など）

### 透明性
- **キャッシュ利用を明示**
  - 「127人の似た性格の方のデータを参考にしています」
  - 「この会議は145人が利用し、平均評価4.2です」
- データソース（Big5Analysis実データ）を明記
- いつでもデータ削除可能

### shared_meetings の管理
- Cloud Functionsのみが書き込み可能
- 全ユーザーが読み取り可能
- 不適切な内容の自動検出（Phase 2）

---

## 📊 成功指標（KPI）

### 短期（3ヶ月）
- 会議機能利用率: 30%以上
- プレミアム転換率: 5%以上
- ユーザー満足度: 4.0/5.0以上
- **キャッシュヒット率: 50%以上**
- **平均レスポンス時間: 2秒以下**

### 長期（1年）
- 月間アクティブユーザー: 1,000人
- プレミアム課金者: 50人以上
- 月間利益: 48,000円以上
- **キャッシュヒット率: 80%以上**
- **月間コスト: 10円以下**

---

## 🚀 次のステップ

1. ~~デザインモックアップ作成~~ ✅
2. ~~Firestoreスキーマ設計~~ ✅（既存DB活用 + shared_meetings）
3. Cloud Functions実装（キャッシュ優先ロジック）
4. SwiftUIで画面実装
5. テンプレート作成（30パターン）
6. **Firestore Index作成（personalityKey + concernCategory）**
7. ベータテスト（キャッシュヒット率測定）
8. 本番リリース

---

## 💡 最新の実装まとめ（2025年12月29日更新）

```
【会話生成】
・100% AI生成（GPT-4o-mini）
・脚本家アプローチで生々しい対話
・BIG5パーソナライズ（各ユーザー固有）
・Phase制（本質探索 → 葛藤 → 統合）

【コスト】
・実測値: 0.0977円/会議（約0.1円）
・初期25円/月 → 3ヶ月後5円/月（80%削減）

【アニメーション】
・2.5〜5秒/メッセージ（長さに応じて動的調整）
・全体約30-40秒でじっくり読める

【スケーラビリティ】
・ユーザー数が増えてもコストは線形増加せず
・キャッシュヒット率が上がるほど効率化

【付加価値】
・人気会議ランキング機能
・高評価会議のレコメンド
・ユーザー間での知見共有（間接的）

【品質】
・既存1,523ユーザーの実データ活用
・100% AI生成で高品質対話
・評価システムで継続的に改善
```

---

次のステップ: キャラクター設計詳細 (`02_characters.md`)
